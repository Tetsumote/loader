"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Loader",t):e.Loader=t()}(this,function(){var e,t=function(){return Math.floor(8999*Math.random())+1e3},n=function(e,t){return String.prototype.includes?e.includes(t):-1!==e.indexOf(t,0)},s=function(e,t){return String.prototype.startsWith?e.startsWith(t):e.substr(0,t.length)===t},r=function(e,t){return Array.prototype.findIndex?e.findIndex(t):function(){for(var n=e.length,s=-1;++s<n;)if(t(e[s],s,e))return s;return-1}()},i=function(e){return e.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()})},o=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},c=function(e){return[].concat(_toConsumableArray(e))},a=function(e,t){return t.indexOf(e)>-1},l=[],u="IntersectionObserver"in window,h="HTMLPictureElement"in window,_=function(e){if(u&&"intersectionRatio"in e)return e.intersectionRatio>0;if("none"===window.getComputedStyle(e,"display"))return!1;var t=document.getElementsByTagName("body")[0],n=window.innerWidth||documnt.documentElement.clientWidth||t.clientWidth,s=window.innerHeight||documnt.documentElement.clientHeight||t.clientHeight,r=e.getBoundingClientRect();return!(r.right<0||r.bottom<0||r.left>n||r.top>s)},d=function(e){if("object"!==(void 0===e?"undefined":_typeof(e)))return!1;try{return e instanceof HTMLElement}catch(t){return 1===e.nodeType&&"object"===_typeof(e.style)&&"object"===_typeof(e.ownerDocument)}},f=function(e){return"string"==typeof e&&a(e,l)||d(e)&&"currentSrc"in e&&e.currentSrc.length>0&&("complete"in e&&e.complete||"readyState"in e&&e.readyState>=2)},m=function(e){return e.buffered.length&&Math.round(e.buffered.end(0))/Math.round(e.seekable.end(0))==1},g=t(),v={image:"jp[e]?g|jpe|jif|jfif|jfi|gif|png|tif[f]?|bmp|dib|webp|ico|cur|svg",audio:"mp3|ogg|oga|spx|ogg|wav",video:"mp4|ogv|webm"},p={image:"img|picture|source",audio:"audio|source",video:"video|source"},b={},y=window.CustomEvent||((e=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}).prototype=window.Event.prototype,e),A=function e(t,r){if(t&&"string"==typeof r)if(s(r,"."))for(var i in b){var o=i.replace("__namespace__",".");n(o,r)&&b[i].element===t&&e(t,o)}else{var c=(r=r.split("."))[0];r[1]&&(r=r.join("__namespace__")),r in b&&(t.removeEventListener(c,b[r].handler),delete b[r])}},E=function(e,t,n,s){if(e&&"string"==typeof t&&"function"==typeof n){var r=(t=t.split("."))[0];if(t[1]&&(t=t.join("__namespace__")),b[t]={element:e,count:0,once:!1},!0===s){var i=n;n=function(n){if(t in b){if(b[t].count++,b[t].once&&b[t].count>1)return;i.call(this,n)}A(e,t)}}else s=!1;b[t]=_extends({},b[t],{handler:n,once:s}),e.addEventListener(r,b[t].handler,{once:s})}},k=function(){function e(t){var n=this;if(_classCallCheck(this,e),this._settings=_extends({srcAttr:"data-src",srcsetAttr:"data-srcset",playthrough:!1,visible:!1},t),!s(this._settings.srcAttr,"data-")||!s(this._settings.srcsetAttr,"data-"))throw new Error("Wrong arguments format: srcAttr and srcsetAttr parameters must be dataset values.");this.srcAttr=i(this._settings.srcAttr.replace("data-","")),this.srcsetAttr=i(this._settings.srcsetAttr.replace("data-","")),this._id=null,this._idEvent=null,this._busy=!1,this._element=null,this._resource=null,this._format=null,this._observer=null,this._observing=!1,this._done=function(){},this._success=function(){},this._error=function(){},this._callback=function(e){n._busy=!1,null!==n._observer&&n._observer.unobserve(n._element);var t=n._element.currentSrc||n._element.src;a(t,l)||l.push(t);var s=[n._element,e.type,t,n._id];n["error"!==e.type?"_success":"_error"].apply(n,s),n._done.apply(n,s)}}return _createClass(e,[{key:"observe",value:function(){this._observing=!0}},{key:"unobserve",value:function(){this._observing=!1}},{key:"process",value:function(){var e,t=this;if(f(this._exists&&this._consistent?this._element:this._resource))return this._busy||A(this._element,"."+this._idEvent),this._callback(new y((e=this._exists&&this._consistent?this._element:this._resource,f(e)&&(d(e)&&("naturalWidth"in e&&0===Math.floor(e.naturalWidth)||"videoWidth"in e&&0===e.videoWidth)||"string"==typeof e)?"error":"load"))),!1;if(this._exists&&this._settings.visible&&!_(this._originalElement))return!1;if("image"===this._format){E(this._element,"load."+this._idEvent,this._callback,!this._busy),E(this._element,"error."+this._idEvent,this._callback,!this._busy);var n=this._element.closest("picture");n&&h?(delete this._element.dataset[this.srcsetAttr],delete this._element.dataset[this.srcAttr],n.querySelectorAll("source["+this._settings.srcsetAttr+"]").forEach(function(e){e.setAttribute("srcset",e.dataset[t.srcAttr]),delete e.dataset[t.srcAttr]})):(this._element.matches("["+this._settings.srcsetAttr+"]")&&(this._element.setAttribute("srcset",this._element.dataset[this.srcsetAttr]),delete this._element.dataset[this.srcsetAttr]),this._element.matches("["+this._settings.srcAttr+"]")&&(this._element.setAttribute("src",this._element.dataset[this.srcAttr]),delete this._element.dataset[this.srcAttr]))}else{if("video"!==this._format&&"audio"!==this._format)return!1;var s=!0===this._settings.playthrough,r="full"===this._settings.playthrough,i=this._element.querySelectorAll("source"),o=!1;i?i.forEach(function(e){e.matches("["+t._settings.srcAttr+"]")&&(e.setAttribute("src",e.dataset[t.srcAttr]),delete e.dataset[t.srcsetAttr],o=!0),E(e,"error."+t._idEvent,function(n){e[g+"_resourceLoader_error"]=!0,i.length===c(i).filter(function(e){return!0===e[g+"_resourceLoader_error"]}).length&&t._callback(n)},!t._busy)}):this._element.matches("["+this._settings.srcAttr+"]")&&(this._element.setAttribute("src",this._element.dataset[this.srcAttr]),delete this._element.dataset[this.srcAttr],E(this._element,"error."+this._idEvent,this._callback,!this._busy),o=!0),o&&this._element.load(),E(this._element,"loadedmetadata."+this._idEvent,function(){if(s||r||t._callback(new y("load")),r){var e=setInterval(function(){var n=t._element.readyState>0&&!t._element.duration;n||m(t._element)?(t._element.currentTime=0,!n&&!t._busy&&t._element.paused&&t._element.matches("[autoplay]")&&t._element.play(),clearInterval(e),t._callback(new y(n?"error":"load"))):(t._element.paused||t._element.pause(),t._busy||(t._element.currentTime+=2))},500);t._element["resourceLoader_"+t._idEvent]=e}},!this._busy),E(this._element,"canplay."+this._idEvent,function(){r&&0===t._element.currentTime&&!m(t._element)&&t._element.currentTime++},!this._busy),E(this._element,"canplaythrough."+this._idEvent,function(){s&&t._callback(new y("load"))},!this._busy)}return this._busy||(this._element[g+"_IDEvent"]=this._idEvent),this._resource=this._element.currentSrc||this._element.src,!this._busy}},{key:"done",value:function(e){"function"==typeof e&&(this._done=function(t,n,s,r){e.apply(this,[t,n,s,r])})}},{key:"abort",value:function(){if(A(this._element,"."+this._idEvent),!f(this._exists?this._element:this._resource)){var e=this._element.getAttribute("srcset"),t=this._element.getAttribute("src");void 0!==e&&(this._element.dataset[this.srcAttr]=e,this._element.setAttribute(this._settings.srcAttr,e),this._element.removeAttribute("src"),this._element.removeAttribute("srcset")),void 0!==t&&(this._element.dataset[this.srcsetAttr]=t,this._element.setAttribute(this._settings.srcsetAttr,t),this._element.removeAttribute("src"),this._element.removeAttribute("srcset"))}}},{key:"resource",set:function(e){var s=this;if("object"===(void 0===e?"undefined":_typeof(e))&&"id"in e&&"element"in e&&"resource"in e){this._id=e.id,this._element=e.element,this._resource=e.resource,this._busy=void 0!==this._idEvent;var r=function(e){var t={format:null,extension:null,tag:null,consistent:!1};for(var s in e.resource=e.resource.split("?")[0],e.resource=e.resource.split("#")[0],v)if(new RegExp("(.("+v[s]+")$)|;base64,","g").test(e.resource)){if(new RegExp(";base64,","g").test(e.resource)){var r=e.resource.match(new RegExp("^data:"+s+"/("+v[s]+")","g"));if(null===r)return;r=r[0],t.format=s,t.extension=r.replace("data:"+s+"/",""),t.tag=p[s];break}var i=e.resource.match(new RegExp(v[s],"g"));if(i){t.format=s,t.extension=i[0],t.tag=p[s];break}}if(d(e.element)){var o=e.element.tagName.toLowerCase(),c="";if(Object.values(p).forEach(function(e){c+="|"+e}),c=c.split("|"),a(o,c)&&(t.tag=o,t.consistent=!0,null===t.format))for(var l in p)if(n(p[l],t.tag)){t.format=l;break}}return n(t.tag,"|")&&(t.tag=t.tag.split("|")[0]),t}({resource:this._resource,element:this._element});this._tag=r.tag,this._consistent=r.consistent,this._format=r.format,this._exists=null!==this._element,this._originalElement=this._element,this._exists&&this._consistent||(this._element=document.createElement(this._tag),this._element.dataset[this.srcAttr]=this._resource),this._idEvent=this._busy?this._element[g+"_IDEvent"]:"resourceLoader_unique_"+this._element.tagName+"_"+t(),this._exists&&this._settings.visible&&u&&(this._observer=new IntersectionObserver(function(e,t){e.forEach(function(e){e.target.intersectionRatio=e.intersectionRatio,s._observing&&s.process()})},{root:null,rootMargin:"0px",threshold:.1}),this._observer.observe(this._originalElement))}},get:function(){return this._resource}}]),e}();return function(){function e(t){if(_classCallCheck(this,e),this._collection=[],this._collectionLoaded=[],this._collectionInstances=[],this._collectionPending=[],this._resourcesLoaded=[],this._observing=!1,this._settings=_extends({srcAttr:"data-src",srcsetAttr:"data-srcset",playthrough:!1,visible:!1,backgrounds:!1},t),!s(this._settings.srcAttr,"data-")||!s(this._settings.srcsetAttr,"data-"))throw new Error("Wrong arguments format: srcAttr and srcsetAttr parameters must be dataset values.");this.srcAttr=i(this._settings.srcAttr.replace("data-","")),this.srcsetAttr=i(this._settings.srcsetAttr.replace("data-","")),this.percentage=0,this._done=function(){},this._progress=function(){},this._success=function(){},this._error=function(){},this._loop=this.load,this._abort=!1,this._loaded=0,this._complete=!1,this._busy=!1}return _createClass(e,[{key:"observe",value:function(){}},{key:"observe",value:function(){this._observing=!0}},{key:"unobserve",value:function(){this._observing=!1}},{key:"load",value:function(){var e=this;this._collection.length||this._done.call(this,this._resourcesLoaded),this._collectionPending=[];for(var t=!0===this._settings.sequential,n=function(n){if(e._abort)return"break";var s=e._collection[n].id,i=r(e._collectionInstances,function(e){return e.id===s}),c=new k(e._settings);e._observing&&c.observe(),-1===i?(e._collectionInstances.push({id:s,instance:c}),i=r(e._collectionInstances,function(e){return e.id===s})):e._collectionInstances[i].instance=c,c.resource=e._collection[n],c.done(function(n,s,r,i){if(!e._complete&&!e._abort){var c=!a(i,e._collectionLoaded);if(c){e._collectionLoaded.push(i),e._busy=!1,e._loaded++,e.percentage=e._loaded/e._collection.length*100,e.percentage=parseFloat(e.percentage.toFixed(4));var l={resource:r,status:s,element:n};e._resourcesLoaded.push(l),e._progress.call(e,l),e["error"!==s?"_success":"_error"].call(e,l),n.dispatchEvent(new CustomEvent("resource"+o(s),{detail:l})),document.dispatchEvent(new CustomEvent("resource"+o(s),{detail:l}))}e._loaded===e._collection.length?(e._done.call(e,e._resourcesLoaded),e._complete=!0):c&&t&&e._collectionPending.length&&(e._collectionPending=e._collectionPending.filter(function(e){return e.id!==i}),e._collectionPending.length&&(e._busy=e._collectionPending[0].instance.process()))}}),!t||t&&!e._busy?e._busy=c.process():t&&e._busy&&(!e._settings.visible||!c._exists||e._settings.visible&&c._exists&&_(c._originalElement))&&e._collectionPending.push({id:s,instance:c})},s=0;s<this._collection.length;s++){if("break"===n(s))break}}},{key:"done",value:function(e){"function"==typeof e&&(this._done=function(t){e.call(this,t)})}},{key:"progress",value:function(e){"function"==typeof e&&(this._progress=function(t){e.call(this,t)})}},{key:"success",value:function(e){"function"==typeof e&&(this._success=function(t){e.call(this,t)})}},{key:"error",value:function(e){"function"==typeof e&&(this._error=function(t){e.call(this,t)})}},{key:"abort",value:function(){this._collectionInstances.forEach(function(e){e.instance.abort()}),this._abort=!0}},{key:"collection",set:function(n){var s=this,r=n;try{r=e.findResources(n,this._settings)}catch(e){}r.forEach(function(e){var n={resource:"",element:null,id:t()};if("string"==typeof e)n.resource=e;else{if(!("object"===(void 0===e?"undefined":_typeof(e))&&"resource"in e))return;n=_extends({},n,e)}s._collection.push(n)})},get:function(){return this._collection}}],[{key:"findResources",value:function(e,t){var n={srcAttr:"src",srcsetAttr:"srcset",backgrounds:!1};if("object"===(void 0===e?"undefined":_typeof(e))&&void 0===t)for(var s in n)if(s in e){t=e,e=void 0;break}if(void 0!==e&&e!==document||(e=document.body),!d(e))throw new Error("TypeError: "+e+" is not of type HTMLElement.");var r=[];n=_extends({},n,t);var i="img, video, audio, picture, source",o="["+n.srcAttr+"], ["+n.srcsetAttr+"]",a=c(e.querySelectorAll("img, video, audio"));if(e.matches(i)&&a.push(e),(a=a.filter(function(e){var t=c(e.children);return t=(t=t.filter(function(e){return e.matches(i)})).filter(function(e){return e.matches(o)}),e.matches(o)||t.length})).forEach(function(e){var t=e;t.matches(o)||(t=t.querySelectorAll(o),t=[].concat(_toConsumableArray(t))[0]),r.push({element:e,resource:t.getAttribute(n.srcAttr)||t.getAttribute(n.srcsetAttr)})}),!0===n.backgrounds){var l=c(e.querySelectorAll("*"));l.push(e),(l=(l=l.filter(function(e){return!e.matches(i)})).filter(function(e){return"none"!==getComputedStyle(e).backgroundImage})).forEach(function(e){var t=getComputedStyle(e).backgroundImage.match(/\((.*?)\)/);null!==t&&t.length>=2&&r.push({element:e,resource:t[1].replace(/('|")/g,"")})})}return r}}]),e}()});
//# sourceMappingURL=loader.min.js.map
