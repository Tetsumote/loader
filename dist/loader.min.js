"use strict";var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}!function(t,e){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Loader",e):t.Loader=e()}(this,function(){var t,e=function(){return Math.floor(8999*Math.random())+1e3},n=function(t,e){return String.prototype.includes?t.includes(e):-1!==t.indexOf(e,0)},r=function(t,e){return String.prototype.startsWith?t.startsWith(e):t.substr(0,e.length)===e},s=function(t,e){return Array.prototype.findIndex?t.findIndex(e):function(){for(var n=t.length,r=-1;++r<n;)if(e(t[r],r,t))return r;return-1}()},i=function(t){return t.replace(/-([a-z])/g,function(t){return t[1].toUpperCase()})},o=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},c=function(t){return[].concat(_toConsumableArray(t))},a=function(t,e){return e.indexOf(t)>-1},l=[],u="IntersectionObserver"in window,h="HTMLPictureElement"in window,_=function(t){if(u&&"intersectionRatio"in t)return t.intersectionRatio>0;if("none"===window.getComputedStyle(t,"display"))return!1;var e=document.getElementsByTagName("body")[0],n=window.innerWidth||documnt.documentElement.clientWidth||e.clientWidth,r=window.innerHeight||documnt.documentElement.clientHeight||e.clientHeight,s=t.getBoundingClientRect();return!(s.right<0||s.bottom<0||s.left>n||s.top>r)},d=function(t){if("object"!==(void 0===t?"undefined":_typeof(t)))return!1;try{return t instanceof HTMLElement}catch(e){return 1===t.nodeType&&"object"===_typeof(t.style)&&"object"===_typeof(t.ownerDocument)}},f=function(t){return"string"==typeof t&&a(t,l)||d(t)&&"currentSrc"in t&&t.currentSrc.length>0&&("complete"in t&&t.complete||"readyState"in t&&t.readyState>=2)},m=function(t){return t.buffered.length&&Math.round(t.buffered.end(0))/Math.round(t.seekable.end(0))==1},g=e(),p={image:"jp[e]?g|jpe|jif|jfif|jfi|gif|png|tif[f]?|bmp|dib|webp|ico|cur|svg",audio:"mp3|ogg|oga|spx|ogg|wav",video:"mp4|ogv|webm"},v={image:"img|picture|source",audio:"audio|source",video:"video|source"},b={},y=window.CustomEvent||((t=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n}).prototype=window.Event.prototype,t),A=function t(e,s){if(e&&"string"==typeof s)if(r(s,"."))for(var i in b){var o=i.replace("__namespace__",".");n(o,s)&&b[i].element===e&&t(e,o)}else{var c=(s=s.split("."))[0];s[1]&&(s=s.join("__namespace__")),s in b&&(e.removeEventListener(c,b[s].handler),delete b[s])}},E=function(t,e,n,r){if(t&&"string"==typeof e&&"function"==typeof n){var s=(e=e.split("."))[0];if(e[1]&&(e=e.join("__namespace__")),b[e]={element:t,count:0,once:!1},!0===r){var i=n;n=function(n){if(e in b){if(b[e].count++,b[e].once&&b[e].count>1)return;i.call(this,n)}A(t,e)}}else r=!1;b[e]=_extends({},b[e],{handler:n,once:r}),t.addEventListener(s,b[e].handler,{once:r})}},w=function(){function t(e){var n=this;if(_classCallCheck(this,t),this._settings=_extends({srcAttr:"data-src",srcsetAttr:"data-srcset",playthrough:!1,visible:!1},e),!r(this._settings.srcAttr,"data-")||!r(this._settings.srcsetAttr,"data-"))throw new Error("Wrong arguments format: srcAttr and srcsetAttr parameters must be dataset values.");this.srcAttr=i(this._settings.srcAttr.replace("data-","")),this.srcsetAttr=i(this._settings.srcsetAttr.replace("data-","")),this._id=null,this._idEvent=null,this._busy=!1,this._element=null,this._resource=null,this._format=null,this._observer=null,this._done=function(){},this._success=function(){},this._error=function(){},this._callback=function(t){n._busy=!1,null!==n._observer&&n._observer.unobserve(n._element);var e=n._element.currentSrc||n._element.src;a(e,l)||l.push(e);var r=[n._element,t.type,e,n._id];n["error"!==t.type?"_success":"_error"].apply(n,r),n._done.apply(n,r)}}return _createClass(t,[{key:"load",value:function(){var t,e=this;if(f(this._exists&&this._consistent?this._element:this._resource))return this._busy||A(this._element,"."+this._idEvent),this._callback(new y((t=this._exists&&this._consistent?this._element:this._resource,f(t)&&(d(t)&&("naturalWidth"in t&&0===Math.floor(t.naturalWidth)||"videoWidth"in t&&0===t.videoWidth)||"string"==typeof t)?"error":"load"))),!1;if(this._exists&&this._settings.visible&&!_(this._originalElement))return!1;if("image"===this._format){E(this._element,"load."+this._idEvent,this._callback,!this._busy),E(this._element,"error."+this._idEvent,this._callback,!this._busy);var n=this._element.closest("picture");n&&h?(delete this._element.dataset[this.srcsetAttr],delete this._element.dataset[this.srcAttr],n.querySelectorAll("source["+this._settings.srcsetAttr+"]").forEach(function(t){t.setAttribute("srcset",t.dataset[e.srcAttr]),delete t.dataset[e.srcAttr]})):(this._element.matches("["+this._settings.srcsetAttr+"]")&&(this._element.setAttribute("srcset",this._element.dataset[this.srcsetAttr]),delete this._element.dataset[this.srcsetAttr]),this._element.matches("["+this._settings.srcAttr+"]")&&(this._element.setAttribute("src",this._element.dataset[this.srcAttr]),delete this._element.dataset[this.srcAttr]))}else{if("video"!==this._format&&"audio"!==this._format)return!1;var r=!0===this._settings.playthrough,s="full"===this._settings.playthrough,i=this._element.querySelectorAll("source"),o=!1;i?i.forEach(function(t){t.matches("["+e._settings.srcAttr+"]")&&(t.setAttribute("src",t.dataset[e.srcAttr]),delete t.dataset[e.srcsetAttr],o=!0),E(t,"error."+e._idEvent,function(n){t[g+"_resourceLoader_error"]=!0,i.length===c(i).filter(function(t){return!0===t[g+"_resourceLoader_error"]}).length&&e._callback(n)},!e._busy)}):this._element.matches("["+this._settings.srcAttr+"]")&&(this._element.setAttribute("src",this._element.dataset[this.srcAttr]),delete this._element.dataset[this.srcAttr],E(this._element,"error."+this._idEvent,this._callback,!this._busy),o=!0),o&&this._element.load(),E(this._element,"loadedmetadata."+this._idEvent,function(){if(r||s||e._callback(new y("load")),s){var t=setInterval(function(){var n=e._element.readyState>0&&!e._element.duration;n||m(e._element)?(e._element.currentTime=0,!n&&!e._busy&&e._element.paused&&e._element.matches("[autoplay]")&&e._element.play(),clearInterval(t),e._callback(new y(n?"error":"load"))):(e._element.paused||e._element.pause(),e._busy||(e._element.currentTime+=2))},500);e._element["resourceLoader_"+e._idEvent]=t}},!this._busy),E(this._element,"canplay."+this._idEvent,function(){s&&0===e._element.currentTime&&!m(e._element)&&e._element.currentTime++},!this._busy),E(this._element,"canplaythrough."+this._idEvent,function(){r&&e._callback(new y("load"))},!this._busy)}return this._busy||(this._element[g+"_IDEvent"]=this._idEvent),this._resource=this._element.currentSrc||this._element.src,!this._busy}},{key:"done",value:function(t){"function"==typeof t&&(this._done=function(e,n,r,s){t.apply(this,[e,n,r,s])})}},{key:"abort",value:function(){if(A(this._element,"."+this._idEvent),!f(this._exists?this._element:this._resource)){var t=this._element.getAttribute("srcset"),e=this._element.getAttribute("src");void 0!==t&&(this._element.dataset[this.srcAttr]=t,this._element.setAttribute(this._settings.srcAttr,t),this._element.removeAttribute("src"),this._element.removeAttribute("srcset")),void 0!==e&&(this._element.dataset[this.srcsetAttr]=e,this._element.setAttribute(this._settings.srcsetAttr,e),this._element.removeAttribute("src"),this._element.removeAttribute("srcset"))}}},{key:"resource",set:function(t){if("object"===(void 0===t?"undefined":_typeof(t))&&"id"in t&&"element"in t&&"resource"in t){this._id=t.id,this._element=t.element,this._resource=t.resource,this._busy=void 0!==this._idEvent;var r=function(t){var e={format:null,extension:null,tag:null,consistent:!1};for(var r in t.resource=t.resource.split("?")[0],t.resource=t.resource.split("#")[0],p)if(new RegExp("(.("+p[r]+")$)|;base64,","g").test(t.resource)){if(new RegExp(";base64,","g").test(t.resource)){var s=t.resource.match(new RegExp("^data:"+r+"/("+p[r]+")","g"));if(null===s)return;s=s[0],e.format=r,e.extension=s.replace("data:"+r+"/",""),e.tag=v[r];break}var i=t.resource.match(new RegExp(p[r],"g"));if(i){e.format=r,e.extension=i[0],e.tag=v[r];break}}if(d(t.element)){var o=t.element.tagName.toLowerCase(),c="";if(Object.values(v).forEach(function(t){c+="|"+t}),c=c.split("|"),a(o,c)&&(e.tag=o,e.consistent=!0,null===e.format))for(var l in v)if(n(v[l],e.tag)){e.format=l;break}}return n(e.tag,"|")&&(e.tag=e.tag.split("|")[0]),e}({resource:this._resource,element:this._element});this._tag=r.tag,this._consistent=r.consistent,this._format=r.format,this._exists=null!==this._element,this._originalElement=this._element,this._exists&&this._consistent||(this._element=document.createElement(this._tag),this._element.dataset[this.srcAttr]=this._resource),this._idEvent=this._busy?this._element[g+"_IDEvent"]:"resourceLoader_unique_"+this._element.tagName+"_"+e(),this._exists&&this._settings.visible&&u&&(this._observer=new IntersectionObserver(function(t,e){t.forEach(function(t){return t.target.intersectionRatio=t.intersectionRatio})},{root:null,rootMargin:"0px",threshold:.1}),this._observer.observe(this._originalElement))}},get:function(){return this._resource}}]),t}();return function(){function t(e){if(_classCallCheck(this,t),this._collection=[],this._collectionLoaded=[],this._collectionInstances=[],this._collectionPending=[],this._resourcesLoaded=[],this._settings=_extends({srcAttr:"data-src",srcsetAttr:"data-srcset",playthrough:!1,visible:!1,backgrounds:!1},e),!r(this._settings.srcAttr,"data-")||!r(this._settings.srcsetAttr,"data-"))throw new Error("Wrong arguments format: srcAttr and srcsetAttr parameters must be dataset values.");this.srcAttr=i(this._settings.srcAttr.replace("data-","")),this.srcsetAttr=i(this._settings.srcsetAttr.replace("data-","")),this.percentage=0,this._done=function(){},this._progress=function(){},this._success=function(){},this._error=function(){},this._loop=this.load,this._abort=!1,this._loaded=0,this._complete=!1,this._busy=!1}return _createClass(t,[{key:"load",value:function(){var t=this;this._collection.length||this._done.call(this,this._resourcesLoaded),this._collectionPending=[];for(var e=!0===this._settings.sequential,n=function(n){if(t._abort)return"break";var r=t._collection[n].id,i=s(t._collectionInstances,function(t){return t.id===r}),c=new w(t._settings);-1===i?(t._collectionInstances.push({id:r,instance:c}),i=s(t._collectionInstances,function(t){return t.id===r})):t._collectionInstances[i].instance=c,c.resource=t._collection[n],c.done(function(n,r,s,i){if(!t._complete&&!t._abort){var c=!a(i,t._collectionLoaded);if(c){t._collectionLoaded.push(i),t._busy=!1,t._loaded++,t.percentage=t._loaded/t._collection.length*100,t.percentage=parseFloat(t.percentage.toFixed(4));var l={resource:s,status:r,element:n};t._resourcesLoaded.push(l),t._progress.call(t,l),t["error"!==r?"_success":"_error"].call(t,l),n.dispatchEvent(new CustomEvent("resource"+o(r),{detail:l})),document.dispatchEvent(new CustomEvent("resource"+o(r),{detail:l}))}t._loaded===t._collection.length?(t._done.call(t,t._resourcesLoaded),t._complete=!0):c&&e&&t._collectionPending.length&&(t._collectionPending=t._collectionPending.filter(function(t){return t.id!==i}),t._collectionPending.length&&(t._busy=t._collectionPending[0].instance.load()))}}),!e||e&&!t._busy?t._busy=c.load():e&&t._busy&&(!t._settings.visible||!c._exists||t._settings.visible&&c._exists&&_(c._originalElement))&&t._collectionPending.push({id:r,instance:c})},r=0;r<this._collection.length;r++){if("break"===n(r))break}}},{key:"done",value:function(t){"function"==typeof t&&(this._done=function(e){t.call(this,e)})}},{key:"progress",value:function(t){"function"==typeof t&&(this._progress=function(e){t.call(this,e)})}},{key:"success",value:function(t){"function"==typeof t&&(this._success=function(e){t.call(this,e)})}},{key:"error",value:function(t){"function"==typeof t&&(this._error=function(e){t.call(this,e)})}},{key:"abort",value:function(){this._collectionInstances.forEach(function(t){t.instance.abort()}),this._abort=!0}},{key:"collection",set:function(n){var r=this,s=n;try{s=t.findResources(n,this._settings)}catch(t){}s.forEach(function(t){var n={resource:"",element:null,id:e()};if("string"==typeof t)n.resource=t;else{if(!("object"===(void 0===t?"undefined":_typeof(t))&&"resource"in t))return;n=_extends({},n,t)}r._collection.push(n)})},get:function(){return this._collection}}],[{key:"findResources",value:function(t,e){var n={srcAttr:"src",srcsetAttr:"srcset",backgrounds:!1};if("object"===(void 0===t?"undefined":_typeof(t))&&void 0===e)for(var r in n)if(r in t){e=t,t=void 0;break}if(void 0!==t&&t!==document||(t=document.body),!d(t))throw new Error("TypeError: "+t+" is not of type HTMLElement.");var s=[];n=_extends({},n,e);var i="img, video, audio, picture, source",o="["+n.srcAttr+"], ["+n.srcsetAttr+"]",a=c(t.querySelectorAll("img, video, audio"));if(t.matches(i)&&a.push(t),(a=a.filter(function(t){var e=c(t.children);return e=(e=e.filter(function(t){return t.matches(i)})).filter(function(t){return t.matches(o)}),t.matches(o)||e.length})).forEach(function(t){var e=t;e.matches(o)||(e=e.querySelectorAll(o),e=[].concat(_toConsumableArray(e))[0]),s.push({element:t,resource:e.getAttribute(n.srcAttr)||e.getAttribute(n.srcsetAttr)})}),!0===n.backgrounds){var l=c(t.querySelectorAll("*"));l.push(t),(l=(l=l.filter(function(t){return!t.matches(i)})).filter(function(t){return"none"!==getComputedStyle(t).backgroundImage})).forEach(function(t){var e=getComputedStyle(t).backgroundImage.match(/\((.*?)\)/);null!==e&&e.length>=2&&s.push({element:t,resource:e[1].replace(/('|")/g,"")})})}return s}}]),t}()});
//# sourceMappingURL=loader.min.js.map
